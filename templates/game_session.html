{% extends "layout.html" %}

{% block content %}

<style>
    .message-history {
    height: 300px;  /* Adjust as needed */
    overflow-y: scroll;
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 20px;
}
</style>

<h2>{{ game.title }}</h2>

<p>Welcome, {{ player.role }}!</p>

<h3>Message History:</h3>
<div class="message-history">
    {% for message in messages|reverse %}
        <div class="message">
            <strong>{{ message.player.user.username }}:</strong> {{ message.content }}
        </div>
    {% endfor %}
</div>

<h3>Game Command Prompt:</h3>
<form action="{{ url_for('game_session', game_id=game.id) }}" method="post">
    <textarea name="command" rows="4" cols="50" placeholder="Enter your command..."></textarea><br>
    <input type="submit" value="Submit Command">
</form>


<h3>Players in Game:</h3>
<table border="1">
    <thead>
        <tr>
            <th>Player Name</th>
            <th>Role</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        {% for p in players %}
        <tr>
            <td>{{ p.user.username }}</td>
            <td>{{ p.role }}</td>
            <td class="player-status" data-player-id="{{ p.id }}">Disconnected</td>  <!-- Default state -->
        </tr>
        {% endfor %}
    </tbody>
</table>

<h3>Entities in Game:</h3>
<table border="1">
    <thead>
        <tr>
            <th>Entity Name</th>
            <th>Current Health</th>
        </tr>
    </thead>
    <tbody>
        {% for entity_instance in entity_instances %}
        <tr>
            <td>{{ entity_instance.base_entity.name }}</td>
            <td>{{ entity_instance.current_health }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Include Socket.IO JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
    var socket = io.connect('http://' + document.domain + ':' + location.port);

    // Emit join event to join the correct game room
    socket.emit('join', {'game_id': '{{ game.id }}'});

    var form = document.querySelector("form");
    var textarea = document.querySelector("textarea[name='command']");

    textarea.addEventListener('keypress', function(event) {
        // Check if the pressed key is the return/enter key and the shift key is not pressed
        if (event.keyCode === 13 && !event.shiftKey) {
            event.preventDefault();  // prevent newline insertion
            form.dispatchEvent(new Event('submit'));  // trigger the form submission
        }
    });

    form.addEventListener("submit", function(event) {
    event.preventDefault();

    var messageContent = textarea.value;
    
    // Disable textarea and send button for 3 seconds after sending a message
    textarea.disabled = true;
    setTimeout(function() {
        textarea.disabled = false;
        textarea.focus();
    }, 3000);  // 3 seconds

    socket.emit('send_message', {'game_id': '{{ game.id }}', 'user': '{{ player.user.username }}', 'content': messageContent});
    textarea.value = '';  // Clear the input field
});

socket.on('new_message', function(data) {
    // Create the new message element
    var newMessage = document.createElement("div");
    newMessage.innerHTML = "<strong>" + data.user + ":</strong> ";

    // Append the new message element to the message history div
    var messageDiv = document.querySelector(".message-history");
    messageDiv.appendChild(newMessage);

    // Scroll to the bottom immediately after appending the new message
    messageDiv.scrollTop = messageDiv.scrollHeight;

    // Type out the message content with a typewriter effect
    var content = data.content;
    var index = 0;
    var typingSpeed = 10;  // Adjust the speed as needed

    function typeCharacter() {
        if (index < content.length) {
            newMessage.innerHTML += content.charAt(index);
            index++;
            setTimeout(typeCharacter, typingSpeed);
        }
    }

    typeCharacter();
});

    // When a player connects
    socket.on('player_connected', function(data) {
        var statusElement = document.querySelector('.player-status[data-player-id="' + data.player_id + '"]');
        if (statusElement) {
            statusElement.textContent = 'Connected';
        }
    });

    // When a player disconnects
    socket.on('player_disconnected', function(data) {
        var statusElement = document.querySelector('.player-status[data-player-id="' + data.player_id + '"]');
        if (statusElement) {
            statusElement.textContent = 'Disconnected';
        }
    });

</script>





{% endblock %}
