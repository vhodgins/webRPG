{% extends "layout.html" %}

{% block content %}

<style>
    .message-history {
    height: 300px;  /* Adjust as needed */
    overflow-y: scroll;
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 20px;
}

.system-message {
    color: red;  /* Or any style you prefer for system messages */
}

</style>

<div class="container mt-4">
    <h2>{{ game.title }}</h2>

    <div class="message-history mb-4">
        {% for message in messages|reverse %}
        <div class="message">
            <strong>{{ message.player.user.username }}:</strong> 
            {% if message.player.user.username == 'System' %}
                <span class="system-message">{{ message.content }}</span>
            {% else %}
                {{ message.content }}
            {% endif %}
        </div>
    {% endfor %}
    </div>
    <form action="{{ url_for('game_session', game_id=game.id) }}" method="post" class="mb-4">
        <div class="form-group">
            <textarea name="command" class="form-control" rows="2" placeholder="Enter your command..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit Command</button>
    </form>

    <div class="row">
        <div class="col-md-6">
            <h3>Players in Game:</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Health</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in players %}
                    <tr>
                        <td>{{ p.name }}</td>
                        <td>{{ p.health }}</td>
                        <td id="status_{{ p.id }}">Offline</td> <!-- Default to offline, will update via Socket.IO -->
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="col-md-6">
            <h3>Entities in Game:</h3>
            <table class="table" id="entities-tbody">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Current Health</th>
                        <!-- You can add other attributes like Attack, Defense, etc. -->
                    </tr>
                </thead>
                <tbody>
                    {% for entity_instance in entity_instances %}
                    <tr>
                        <td>{{ entity_instance.base_entity.name }}</td>
                        <td>{{ entity_instance.current_health }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>




<!-- Include Socket.IO JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
    var socket = io.connect('http://' + document.domain + ':' + location.port);

    socket.on('connect', function() {
    //console.log('Connected to the server');
    socket.emit('join', {'game_id': '{{ game.id }}'});
    });

    var form = document.querySelector("form");
    var textarea = document.querySelector("textarea[name='command']");

    textarea.addEventListener('keypress', function(event) {
        // Check if the pressed key is the return/enter key and the shift key is not pressed
        if (event.keyCode === 13 && !event.shiftKey) {
            event.preventDefault();  // prevent newline insertion
            form.dispatchEvent(new Event('submit'));  // trigger the form submission
        }
    });

    form.addEventListener("submit", function(event) {
    event.preventDefault();

    var messageContent = textarea.value;
    
    // Disable textarea and send button for 3 seconds after sending a message
    textarea.disabled = true;
    setTimeout(function() {
        textarea.disabled = false;
        textarea.focus();
    }, 3000);  // 3 seconds

    socket.emit('send_message', {'game_id': '{{ game.id }}', 'user': '{{ player.user.username }}', 'content': messageContent});
    textarea.value = '';  // Clear the input field
});

socket.on('new_message', function(data) {
    // Create the new message element
    var newMessage = document.createElement("div");
    newMessage.innerHTML = "<strong>" + data.user + ":</strong> ";

    // Append the new message element to the message history div
    var messageDiv = document.querySelector(".message-history");
    messageDiv.appendChild(newMessage);

    // Scroll to the bottom immediately after appending the new message
    messageDiv.scrollTop = messageDiv.scrollHeight;

    // Type out the message content with a typewriter effect
    var content = data.content;
    var index = 0;
    var typingSpeed = 10;  // Adjust the speed as needed

    function typeCharacter() {
        if (index < content.length) {
            newMessage.innerHTML += content.charAt(index);
            index++;
            setTimeout(typeCharacter, typingSpeed);
        }
    }

    typeCharacter();
});

// ... existing code ...

socket.on('player_online', function(data) {
    document.getElementById("status_" + data.player_id).innerText = "Online";
});

socket.on('player_offline', function(data) {
    document.getElementById("status_" + data.player_id).innerText = "Offline";
});


socket.on('new_entity', function(data) {
    // Assuming you have a <tbody> element with an id of "entities-tbody" for your entities table
    var entitiesTable = document.getElementById("entities-tbody");

    // Create a new row and populate it with the entity's data
    var newRow = entitiesTable.insertRow();
    var nameCell = newRow.insertCell(0);
    var healthCell = newRow.insertCell(1);
    nameCell.innerText = data.entity_name;
    healthCell.innerText = data.current_health;
});


</script>





{% endblock %}
