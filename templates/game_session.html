{% extends "layout.html" %}

{% block content %}
<h2>{{ game.title }}</h2>

<p>Welcome, {{ player.role }}!</p>

<h3>Message History:</h3>
<div class="message-history">
    {% for message in messages|reverse %}
        <div class="message">
            <strong>{{ message.player.user.username }}:</strong> {{ message.content }}
        </div>
    {% endfor %}
</div>

<h3>Game Command Prompt:</h3>
<form action="{{ url_for('game_session', game_id=game.id) }}" method="post">
    <textarea name="command" rows="4" cols="50" placeholder="Enter your command..."></textarea><br>
    <input type="submit" value="Submit Command">
</form>

<!-- Include Socket.IO JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script type="text/javascript">
    var socket = io.connect('http://' + document.domain + ':' + location.port);

    // Emit join event to join the correct game room
    socket.emit('join', {'game_id': '{{ game.id }}'});

    // Handle form submission
    var form = document.querySelector("form");
    form.addEventListener("submit", function(event) {
        event.preventDefault();
        var messageContent = document.querySelector("textarea[name='command']").value;
        socket.emit('send_message', {'game_id': '{{ game.id }}', 'user': '{{ player.user.username }}', 'content': messageContent});
        document.querySelector("textarea[name='command']").value = '';  // Clear the input field
    });

    socket.on('new_message', function(data) {
        // Append the new message to the message history div
        var messageDiv = document.querySelector(".message-history");
        var newMessage = document.createElement("div");
        newMessage.innerHTML = "<strong>" + data.user + ":</strong> " + data.content;
        messageDiv.appendChild(newMessage);
    });
</script>




{% endblock %}
